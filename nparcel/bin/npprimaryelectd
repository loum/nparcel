#!/usr/bin/python

import os
import inspect

import nparcel
from nparcel.utils.log import (log,
                               set_console,
                               set_log_level)


def main():
    based = nparcel.BaseD()
    based.parser.add_option('-f', '--file',
                            dest='file',
                            help='file to process inline (start only)')
    based.check_args()

    if based.command != 'start' and based.options.file:
        based.parser.error('invalid option(s) with command "%s"' %
                           based.command)

    if based.command == 'status' or based.options.dry is not None:
        set_console()

    # Enable detailed logging if required.
    if based.options.verbose == 0:
        set_log_level('INFO')
    else:
        log.debug('Logging verbosity set to "DEBUG" level')

    # Check if a filename was provided on the command line.
    file = None
    if based.options.file:
        file = based.options.file

    # OK, start processing.
    pidfile = os.path.join(os.path.expanduser('~'),
                           '.nparceld',
                           'npprimaryelectd.pid')
    ped = nparcel.PrimaryElectDaemon(pidfile=pidfile,
                                     file=file,
                                     dry=based.dry,
                                     batch=based.batch,
                                     config=based.options.config)

    script_name = inspect.getfile(inspect.currentframe())
    script_name = os.path.basename(script_name)
    if based.command == 'start':
        if based.dry:
            print('Starting %s inline (dry iteration) ...' % script_name)
            ped._start(ped.exit_event)
        else:
            msg = 'Starting %s as daemon' % script_name
            if based.batch:
                msg = '%s in batch mode' % msg
            print('%s ...' % msg)
            ped.start()
    elif based.command == 'stop':
        print('Stopping %s ...' % script_name)
        ped.stop()
        print('OK')
    elif based.command == 'status':
        if ped.status():
            print('%s is running with PID %d' % (script_name, ped.pid))
        else:
            print('%s is idle' % script_name)

if __name__ == '__main__':
    main()
